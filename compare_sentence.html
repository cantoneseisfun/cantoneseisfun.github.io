<!DOCTYPE html><html lang="zh-Hans"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>常用口语 vs 书面语句子</title>
  <meta name="description" content="点击播放 compare_fun2.docx 中的粤语例句。优先使用粤语TTS，若无则自动回落到合成音。">
  <style>
    :root{
      --bg:#ffffff; --fg:#1f2328; --muted:#5f6b7a; --card:#f6f8fa; --border:#e5e7eb; --accent:#0b72ff;
      --good:#16a34a; --warn:#b45309; --bad:#dc2626;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0f14; --fg:#e5e7eb; --muted:#9aa3ad; --card:#111827; --border:#233044; --accent:#6aa6ff;
        --good:#22c55e; --warn:#f59e0b; --bad:#f87171; }
    }
    [data-theme="dark"]{
      --bg:#0b0f14; --fg:#e5e7eb; --muted:#9aa3ad; --card:#111827; --border:#233044; --accent:#6aa6ff;
      --good:#22c55e; --warn:#f59e0b; --bad:#f87171;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--fg); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,
      "PingFang SC","Microsoft YaHei","Hiragino Sans GB","Noto Sans CJK SC","Noto Sans",ui-sans-serif,system-ui,sans-serif}
    header{position:sticky; top:0; z-index:10; background:var(--bg); border-bottom:1px solid var(--border)}
    .topbar{max-width:1100px; margin:0 auto; padding:.7rem 1rem; display:flex; gap:.5rem; align-items:center}
    .title{font-weight:800}
    .spacer{flex:1}
    .btn{
      appearance:none; border:1px solid var(--border); background:var(--card); color:var(--fg);
      padding:.45rem .7rem; border-radius:.6rem; cursor:pointer; font-weight:600;
    }
    .btn:hover{border-color:var(--accent)}
    .wrap{max-width:1100px; margin:0 auto; padding:1rem}
    .panel{border:1px solid var(--border); border-radius:.8rem; background:var(--card); padding:.8rem}
    .legend{color:var(--muted); font-size:.92em}
    .grid{display:grid; grid-template-columns: 1fr; gap:.5rem}
    @media (min-width:640px){ .grid{grid-template-columns: 1fr 1fr} }
    @media (min-width:980px){ .grid{grid-template-columns: 1fr 1fr 1fr} }
    .card{
      border:1px solid var(--border); border-radius:.8rem; background:var(--bg); padding:.8rem; display:flex; flex-direction:column; gap:.4rem;
    }
    .ex { font-size:1.06rem; font-weight:700 }
    .tr { color:var(--muted) }
    .row{display:flex; gap:.5rem; flex-wrap:wrap; align-items:center}
    .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .footer{max-width:1100px; margin:1rem auto; padding:0 1rem; color:var(--muted); font-size:.9em}
    .secTitle{font-weight:800; margin:.2rem 0 .6rem}
    .pill{display:inline-block; padding:.18rem .5rem; border:1px solid var(--border); border-radius:999px; background:var(--card); font-size:.82rem; color:var(--muted)}
    .playBtn{
      align-self:flex-start; display:inline-flex; gap:.35rem; align-items:center; border:none; background:#0000; color:var(--fg);
      cursor:pointer; padding:.36rem .55rem; border-radius:.5rem; font-weight:700;
    }
    .playBtn:hover{outline:2px solid var(--accent)}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="title">常用口语 vs 书面语句子</div>
      <span id="ttsStatus" class="legend">初始化中…</span>
      <div class="spacer"></div>
    <button id="themeBtn" class="btn" aria-label="切换主题">切换主题</button>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="row" style="gap:.6rem">
        <button class="btn" id="playAll">播放全部例子</button>
        <span class="legend">说明：点击每条例子或“播放全部”。优先系统粤语 TTS（zh-HK / yue）；若不可用则自动用合成音。</span>
      </div>
    </section>

    <section class="panel">
      <div class="secTitle">人地時</div>
      <div class="grid" id="sec1"></div>
    </section>

    <section class="panel">
      <div class="secTitle">动词</div>
      <div class="grid" id="sec2"></div>
    </section>

    <section class="panel">
      <div class="secTitle">状态</div>
      <div class="grid" id="sec3"></div>
    </section>

    <section class="panel">
      <div class="secTitle">连接词</div>
      <div class="grid" id="sec4"></div>
    </section>

    <section class="panel">
      <div class="secTitle">語氣</div>
      <div class="grid" id="sec5"></div>
    </section>
  </main>

  <div class="footer">
    提示：若系统未安装“中文（香港）/粤语”语音包，将自动回落到合成音；如需更自然声音，请在系统设置中启用粤语 TTS。
  </div>

  <script>
    // 主题切换
    const themeBtn = document.getElementById('themeBtn');
    function applyTheme(v){
      v==='dark' ? document.documentElement.setAttribute('data-theme','dark')
                 : document.documentElement.removeAttribute('data-theme');
      localStorage.setItem('theme', v);
    }
    const savedTheme = localStorage.getItem('theme'); if(savedTheme) applyTheme(savedTheme);
    themeBtn.addEventListener('click', ()=>{
      const dark = document.documentElement.getAttribute('data-theme')==='dark';
      applyTheme(dark ? 'light' : 'dark');
    });

    // 数据：仅保留“例子中的粤语句子”，并附上粤拼（用于合成音回落）
    const D = {
      sec1: [
        {yue:"我唔识佢", jp:"ngo5 m4 sik1 keoi5", note:"我不认识他"},
        {yue:"我哋去食饭", jp:"ngo5 dei6 heoi3 sik6 faan6", note:"我们去吃饭"},
        {yue:"你哋几点到？", jp:"nei5 dei6 gei2 dim2 dou3", note:"你们几点到？"},
        {yue:"佢哋系边个？", jp:"keoi5 dei6 hai6 bin1 go3", note:"他们是谁？"},
        {yue:"边个搵我？", jp:"bin1 go3 wan2 ngo5", note:"谁找我？"},
        {yue:"你去边度？", jp:"nei5 heoi3 bin1 dou6", note:"你去哪里？"},
        {yue:"呢度有人坐", jp:"ni1 dou6 jau5 jan4 co5", note:"这里有人坐"},
        {yue:"嗰度有间超市", jp:"go2 dou6 jau5 gaan1 ciu1 si3", note:"那里有家超市"},
        {yue:"而家几点？", jp:"ji4 gaa1 gei2 dim2", note:"现在几点？"},
        {yue:"今日天气好好", jp:"gam1 jat6 tin1 hei3 hou2 hou2", note:"今天天气很好"},
        {yue:"听日见", jp:"ting1 jat6 gin3", note:"明天见"},
        {yue:"琴日我去咗睇戏", jp:"kam4 jat6 ngo5 heoi3 zo2 tai2 hei3", note:"昨天我去了看电影"}
      ],
      sec2: [
        {yue:"佢系我朋友", jp:"keoi5 hai6 ngo5 pang4 jau5", note:"他是我的朋友"},
        {yue:"我喺屋企", jp:"ngo5 hai2 uk1 kei2", note:"我在家里"},
        {yue:"睇电视", jp:"tai2 din6 si6", note:"看电视"},
        {yue:"食饭未？", jp:"sik6 faan6 mei6", note:"吃饭了吗？"},
        {yue:"饮水", jp:"jam2 seoi2", note:"喝水"},
        {yue:"唔好讲大话", jp:"m4 hou2 gong2 daai6 waa6", note:"不要说谎"},
        {yue:"我要去瞓觉喇", jp:"ngo5 jiu3 heoi3 fan3 gaau3 laa3", note:"我要去睡觉了"},
        {yue:"我行先喇", jp:"ngo5 haang4 sin1 laa3", note:"我先走了"},
        {yue:"唔好企喺度", jp:"m4 hou2 kei5 hai2 dou6", note:"不要站在这里"},
        {yue:"走鬼啊！", jp:"zau2 gwai2 aa3", note:"小贩逃跑时用语"},
        {yue:"俾支笔我", jp:"bei2 zi1 bat1 ngo5", note:"给我一支笔"},
        {yue:"我搵紧锁匙", jp:"ngo5 wan2 gan2 so2 si4", note:"我正在找钥匙"},
        {yue:"帮我攞杯水", jp:"bong1 ngo5 lo2 bui1 seoi2", note:"帮我拿杯水"},
        {yue:"我谂紧办法", jp:"ngo5 nam2/soeng2 gan2 baan6 faat3", note:"我正在想办法"},
        {yue:"着衫", jp:"zoek3 saam1", note:"穿衣服"},
        {yue:"除鞋", jp:"ceoi4 haai4", note:"脱鞋"},
        {yue:"前面落车", jp:"cin4 min6 lok6 ce1", note:"前面下车"}
      ],
      sec3: [
        {yue:"佢好靓女", jp:"keoi5 hou2 leng3 neoi2", note:"她很漂亮"},
        {yue:"我好攰", jp:"ngo5 hou2 gui6", note:"我很累"},
        {yue:"唔好嬲啦", jp:"m4 hou2 nau1 laa1", note:"别生气啦"},
        {yue:"我好惊老鼠", jp:"ngo5 hou2 geng1 lou5 syu2", note:"我很怕老鼠"},
        {yue:"你系咪癫㗎？", jp:"nei5 hai6 mai6 din1 gaa3", note:"你是不是疯了？"},
        {yue:"做人唔好咁戆居", jp:"zou6 jan4 m4 hou2 gam3 ong6 geoi1", note:"做人不要这么傻"},
        {yue:"你好劲啊！", jp:"nei5 hou2 ging6 aa3", note:"你很厉害啊！"},
        {yue:"啲嘢好平", jp:"di1 je5 hou2 peng4", note:"东西很便宜"},
        {yue:"今日好冻", jp:"gam1 jat6 hou2 dung3", note:"今天很冷"},
        {yue:"一齐食饭", jp:"jat1 cai4 sik6 faan6", note:"一起吃饭"}
      ],
      sec4: [
        {yue:"我嘅书", jp:"ngo5 ge3 syu1", note:"我的书"},
        {yue:"唔好", jp:"m4 hou2", note:"不好/不要"},
        {yue:"我冇钱", jp:"ngo5 mou5 cin2", note:"我没有钱"},
        {yue:"食咗饭", jp:"sik6 zo2 faan6", note:"吃了饭"},
        {yue:"拎住", jp:"ling1 zyu6", note:"拿着"},
        {yue:"食紧饭", jp:"sik6 gan2 faan6", note:"正在吃饭"},
        {yue:"点解你会知？", jp:"dim2 gaai2 nei5 wui5 zi1", note:"为什么你会知道？"},
        {yue:"你食咩？", jp:"nei5 sik6 me1", note:"你吃什么？"},
        {yue:"点做啊？", jp:"dim2 zou6 aa3", note:"怎么做啊？"},
        // “如果/但是”行仅说明，无例句，不加入播放
      ],
      sec5: [
        {yue:"你识佢咩？", jp:"nei5 sik1 keoi5 me1", note:"你认识他吗？（反问/不信）"},
        {yue:"边个嚟呀？", jp:"bin1 go3 lai4 aa3", note:"是谁来啊？"},
        {yue:"我本书呢？", jp:"ngo5 bun2 syu1 ne1", note:"我的书呢？"},
        {yue:"点解会咁嘅？", jp:"dim2 gaai2 wui5 gam3 ge2", note:"为什么会这样？"},
        {yue:"佢系老师嚟㗎。", jp:"keoi5 hai6 lou5 si1 lai4 gaa3", note:"他是老师来的。"},
        {yue:"落雨咪带遮啰。", jp:"lok6 jyu5 mai6 daai3 ze1 lo1", note:"下雨就带伞啊。"},
        {yue:"我食饱喇。", jp:"ngo5 sik6 baau2 laa3", note:"我吃饱了。"},
        {yue:"算数罢啦。", jp:"syun3 sou3 baa6 laa1", note:"算了吧。"},
        {yue:"你快啲啦！", jp:"nei5 faai3 di1 laa1", note:"你快一点吧！"},
        {yue:"帮我睇下。", jp:"bong1 ngo5 tai2 haa5", note:"帮我看一下。"},
        {yue:"不如去睇戏丫？", jp:"bat1 jyu4 heoi3 tai2 hei3 aa1", note:"不如去看电影吧？"},
        {yue:"原来系你喎！", jp:"jyun4 loi4 hai6 nei5 wo3", note:"原来是你喔！"},
        {yue:"十蚊啫，好平。", jp:"sap6 man1 ze1, hou2 peng4", note:"十块钱而已，很便宜。"},
        {yue:"讲笑之嘛。", jp:"gong2 siu3 zi1 maa3", note:"开玩笑而已嘛。"},
        {yue:"佢食亲海鲜都敏感。", jp:"keoi5 sik6 can1 hoi2 sin1 dou1 man5 gam2", note:"他每次吃海鲜都过敏。"}
        // “喎 wo5（转述）”在此文未给例句，故不加入
      ]
    };

    // 构建卡片
    function playIcon(){ return '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>'; }
    function buildSection(secId, items){
      const root = document.getElementById(secId);
      items.forEach((it)=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="ex">${it.yue}</div>
          <div class="tr">${it.note ? it.note : ''}</div>
          <div class="row">
            <span class="pill">粤拼：${(it.jp||'').replace(/\s+/g,' ').trim()}</span>
            <button class="playBtn" data-yue="${it.yue}" data-jp="${it.jp||''}" aria-label="播放">${playIcon()}播放</button>
          </div>
        `;
        root.appendChild(card);
      });
    }
    buildSection('sec1', D.sec1);
    buildSection('sec2', D.sec2);
    buildSection('sec3', D.sec3);
    buildSection('sec4', D.sec4);
    buildSection('sec5', D.sec5);

    // TTS 选择（优先系统粤语）
    let voices = [];
    let yueVoice = null;
    const ttsStatus = document.getElementById('ttsStatus');

    function pickCantoneseVoice(list){
      const prefer = list.find(v => /zh/i.test(v.lang) && /HK/i.test(v.lang));
      if(prefer) return prefer;
      const byName = list.find(v => /yue|cantonese|粤|粵|Hong Kong|HK/i.test((v.name||'') + ' ' + (v.lang||'')));
      if(byName) return byName;
      const zhHK = list.find(v => /zh.*HK/i.test(v.lang||''));
      return zhHK || null;
    }
    function updateVoiceStatus(){
      if(yueVoice){
        ttsStatus.innerHTML = `TTS: <span class="ok">已找到粤语语音（${yueVoice.name}）</span>`;
      }else if(voices.length){
        const langs = [...new Set(voices.map(v=>v.lang))].join(", ");
        ttsStatus.innerHTML = `TTS: <span class="warn">未检测到粤语，将使用合成音</span> <span class="legend">可用语音: ${langs}</span>`;
      }else{
        ttsStatus.innerHTML = `TTS: <span class="warn">正在加载可用语音…</span>`;
      }
    }
    function loadVoices(){
      try{
        voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
        yueVoice = pickCantoneseVoice(voices);
        updateVoiceStatus();
      }catch(e){
        yueVoice = null; updateVoiceStatus();
      }
    }
    if('speechSynthesis' in window){
      loadVoices();
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }else{
      ttsStatus.innerHTML = `TTS: <span class="bad">此浏览器不支持 TTS，将使用合成音</span>`;
    }

    // 事件：播放单条/全部
    function attachPlayHandlers(){
      document.querySelectorAll('.playBtn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const text = btn.getAttribute('data-yue') || '';
          const jp = btn.getAttribute('data-jp') || '';
          speakText(text, jp);
        });
      });
      document.getElementById('playAll').addEventListener('click', async ()=>{
        const all = [...document.querySelectorAll('.playBtn')];
        for(const btn of all){
          const text = btn.getAttribute('data-yue') || '';
          const jp = btn.getAttribute('data-jp') || '';
          await speakTextSeq(text, jp);
        }
      });
    }
    attachPlayHandlers();

    function speakText(text, jp){
      if(yueVoice && 'speechSynthesis' in window){
        const u = new SpeechSynthesisUtterance(text);
        u.voice = yueVoice; u.rate = 0.95; u.pitch = 1.0; u.volume = 1.0;
        u.onerror = ()=> fallbackSynthesis(text, jp);
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      }else{
        fallbackSynthesis(text, jp);
      }
    }
    function speakTextSeq(text, jp){
      return new Promise(resolve=>{
        if(yueVoice && 'speechSynthesis' in window){
          const u = new SpeechSynthesisUtterance(text);
          u.voice = yueVoice; u.rate = 0.95; u.pitch = 1.0;
          u.onend = resolve;
          u.onerror = ()=>{ fallbackSynthesis(text, jp); setTimeout(resolve, Math.max(800, text.length*120)); };
          window.speechSynthesis.speak(u);
        }else{
          fallbackSynthesis(text, jp);
          setTimeout(resolve, Math.max(800, text.length*120));
        }
      });
    }

    // ---------------- Web Audio 合成音（回落方案） ----------------
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioCtx();
    const out = ctx.createGain(); out.gain.value = 0.9; out.connect(ctx.destination);

    function tokenize(jpSentence){
      // 支持 "nam2/soeng2" 两读，默认取第一个
      jpSentence = (jpSentence||'').replace(/(\w+)\s*\/\s*[\w\d]+/g, '$1');
      return jpSentence.split(/[\s,，。！!？?、；;]+/).filter(Boolean);
    }
    function parseJyut(syl){
      const m = syl.match(/^([a-z]+?)(\d)$/i);
      if(!m) return {init:"∅", fin:(syl||'a'), tone:3};
      const base = m[1], tone = Number(m[2]);
      const initials = ["gw","kw","ng","b","p","m","f","d","t","n","l","g","k","h","z","c","s","w","j"];
      let init="∅", fin=base;
      for(const i of initials){ if(base.startsWith(i)){ init=i; fin=base.slice(i.length); break; } }
      return {init, fin, tone};
    }
    function noiseBuffer(ms){
      const len = Math.max(1, Math.floor(ctx.sampleRate * (ms/1000)));
      const buf = ctx.createBuffer(1, len, ctx.sampleRate);
      const d = buf.getChannelData(0);
      for(let i=0;i<len;i++) d[i] = (Math.random()*2-1)*0.6;
      return buf;
    }
    function initialProfile(init){
      switch(init){
        case "p": case "t": case "k": case "kw": return {type:"burst", dur:45, amp:0.9, f:1700};
        case "b": case "d": case "g": case "gw": return {type:"burst", dur:30, amp:0.6, f:1200};
        case "f": case "s": return {type:"fric", dur:120, amp:0.65, f:3200};
        case "z": return {type:"fric", dur:90, amp:0.55, f:2500};
        case "c": return {type:"fric", dur:120, amp:0.6, f:3200};
        case "h": return {type:"breath", dur:120, amp:0.5, f:900};
        case "m": case "n": case "ng": return {type:"nasal", dur:80, amp:0.45, f:180};
        case "l": return {type:"liquid", dur:60, amp:0.45, f:220};
        case "w": case "j": return {type:"glide", dur:40, amp:0.4, f:240};
        default: return {type:"none", dur:0, amp:0, f:0};
      }
    }
    function isStopFinal(fin){ return /(p|t|k)$/.test(fin); }
    function isNasalFinal(fin){ return /(m|n|ng)$/.test(fin); }
    function vowelBase(fin){
      if(/^aa|^a$/.test(fin)) return -2;
      if(/^i/.test(fin)) return 2;
      if(/^u/.test(fin)) return -1;
      if(/^e|^oe|^eo/.test(fin)) return 0;
      if(/^o/.test(fin)) return -1;
      if(/^(m|ng)$/.test(fin)) return -3;
      return 0;
    }
    function toneContour(tone, dur){
      const high=1.0, mid=0.86, low=0.76;
      switch(tone){
        case 1: return t => high;
        case 2: return t => mid + (high-mid)*(t/dur)*0.6;
        case 3: return t => mid;
        case 4: return t => low - (low-0.7)*(t/dur)*0.6;
        case 5: return t => low + 0.08*(t/dur);
        case 6: return t => low;
        default: return t => mid;
      }
    }
    function playInitial(init){
      const p = initialProfile(init);
      if(p.type==="none") return 0;
      const now = ctx.currentTime + 0.005;
      const end = now + p.dur/1000;
      const g = ctx.createGain(); g.gain.value = 0; g.connect(out);
      if(p.type==="fric" || p.type==="breath" || p.type==="burst"){
        const src = ctx.createBufferSource(); src.buffer = noiseBuffer(p.dur);
        const bp = ctx.createBiquadFilter();
        bp.type = p.type==="breath" ? "lowpass" : "bandpass";
        bp.frequency.value = p.f; bp.Q.value = p.type==="burst" ? 2.0 : 0.8;
        src.connect(bp).connect(g);
        src.start(now); src.stop(end);
        g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(p.amp, now + 0.015);
        g.gain.exponentialRampToValueAtTime(0.0001, end);
      }else{
        const osc = ctx.createOscillator(); osc.type="sine";
        const gn = ctx.createGain(); gn.gain.value = 0; osc.frequency.value = 180;
        osc.connect(gn).connect(g);
        osc.start(now); osc.stop(end);
        gn.gain.linearRampToValueAtTime(0.4, now + 0.03);
        gn.gain.exponentialRampToValueAtTime(0.0001, end);
      }
      return p.dur/1000 * 0.8;
    }
    function playVowel(fin, tone){
      const now = ctx.currentTime + 0.005;
      const baseF0 = 185 * Math.pow(2, vowelBase(fin)/12);
      const isStop = isStopFinal(fin);
      const dur = isStop ? 0.16 : 0.34;
      const contour = toneContour(tone, dur);

      const osc = ctx.createOscillator(); osc.type = "sawtooth";
      const shaper = ctx.createBiquadFilter(); shaper.type="lowpass"; shaper.frequency.value = 2300;
      const g = ctx.createGain(); g.gain.value = 0;

      const lfo = ctx.createOscillator(); lfo.type="sine"; lfo.frequency.value = 5.5;
      const lfoGain = ctx.createGain(); lfoGain.gain.value = 3;
      lfo.connect(lfoGain); lfoGain.connect(osc.frequency);

      osc.connect(shaper).connect(g).connect(out);

      const step = 24;
      for(let i=0;i<=step;i++){
        const t = dur * i/step;
        const f = baseF0 * contour(t);
        osc.frequency.linearRampToValueAtTime(f, now + t);
      }
      if(isNasalFinal(fin)){
        shaper.frequency.setValueAtTime(1900, now + 0.04);
      }

      const att = 0.02, dec = 0.05, sus = isStop?0.55:0.7;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.linearRampToValueAtTime(1.0, now + att);
      g.gain.linearRampToValueAtTime(sus, now + att + dec);
      g.gain.linearRampToValueAtTime(0.0001, now + dur + 0.06);

      if(isStop){
        const burstStart = now + dur - 0.04;
        const src = ctx.createBufferSource(); src.buffer = noiseBuffer(60);
        const bp = ctx.createBiquadFilter(); bp.type="bandpass"; bp.frequency.value = 2500; bp.Q.value = 3;
        const g2 = ctx.createGain(); g2.gain.value = 0;
        src.connect(bp).connect(g2).connect(out);
        src.start(burstStart); src.stop(burstStart + 0.06);
        g2.gain.setValueAtTime(0.0001, burstStart);
        g2.gain.linearRampToValueAtTime(0.6, burstStart + 0.01);
        g2.gain.exponentialRampToValueAtTime(0.0001, burstStart + 0.06);
      }

      osc.start(now);
      lfo.start(now);
      osc.stop(now + dur + 0.08);
      lfo.stop(now + dur + 0.09);

      return now + dur + 0.1;
    }
    function playSyllable(syl){
      const {init, fin, tone} = parseJyut(syl);
      const gap = playInitial(init);
      setTimeout(()=> playVowel(fin, tone), Math.max(0, gap*1000));
    }
    function fallbackSynthesis(text, jpFull){
      if(ctx.state==="suspended") ctx.resume();
      const toks = tokenize(jpFull);
      let delay = 0;
      toks.forEach((tk)=>{
        const syls = tk.split(/-/);
        syls.forEach((syl)=>{
          setTimeout(()=> playSyllable(syl), delay);
          delay += 250;
        });
        delay += 90;
      });
    }
  </script>


</body></html>